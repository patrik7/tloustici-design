{% extends 'base/base.html' %}
{% load i18n %}
{% load bootstrap %}

{% block main %}

<div id="data"></div>

{% endblock %}

{% block extra_script %}
  {% if form %}
    <script type="bogus" id="form_template">
      {{form|bootstrap}}
    </script>
  {% endif %}

  <script type="text/javascript" language="javascript">

    function show(i) {
      elem = document.getElementById("post" + i);
      elem.className = elem.className.replace( /(?:^|\s)hidden(?!\S)/g , '' );
    }

    function loadData(root)
    {
      $('#data').html('<div class="text-center"><img src="{{STATIC_URL}}images/loading.gif" width="64" height="64" /></div>');

      {% block load_data %}
      $.getJSON('/forum/data/' + root
      {% endblock %}

      ,{
      }).done(function(entries) {
          $('#data').html('');

          var last_end = 0;

          for (var i = 0; i < entries.length; i++) {
            if (entries[i].level == 3) last_end = i;

            render(i, entries[i], last_end);
          }
        })
        .error(function() {
          $('#data').html('Error loading data');
        });
    }

    function add_form(reply_to) {
      elem = document.getElementById("form_template");

      var txt = 
        '<form method="post" action="/forum/' + reply_to + '/" class="form">'
        + "{% csrf_token %}"
        + elem.innerHTML
        + '<div class="form-group">'
          + '<div>'
            + '<button type="submit" class="btn">Post</button>'
          + '</div>'
        + '</div>'
      + '</form>';

      return txt;
    }

    function render(i, e, last_end) {
      var body = '';
      var footer = '';

      var hidden = '';

      var link = "";
      if (e.is_link) {
        link = 'onClick="loadData(' + e.pk + ')"';
      }

      body += e.text;

      footer =
        '<div class="row">'
        + '<div class="col-sm-6">';

      if (e.level > 1) {
        footer += '<a href="' + e.user_link + '">'
          + '<span class="glyphicon glyphicon-user"></span> ' + e.by_user
          + '</a>';
      }

      footer += '</div><div class="col-sm-6 text-right">';
      if (e.post_count > 0) {
        footer += '<small>' + e.post_count + ' '+ e.posts + '</small> ';
      }

      if (e.level > 0) {
        var s = i;

        if (e.level == 4) s = last_end;

        {% if form %}
          footer += '<div class="btn-group btn-group-xs">'
                    + '<button class="btn" onClick="show(' + (s) + ')"><span class="glyphicon glyphicon-share-alt"></span> {% trans 'Reply' %}</button>'
                  + '</div>'
        {% endif %}
      }

      footer += '</div></div>';

      $('#data').append(
        '<div class="panel panel-default ' + e.html_class + '" style="margin-bottom: 5px;">'
        + '<div class="panel-body" style="padding: 5px;" ' + link + '>'
          + '<div class="row">'
            + '<div class="col-xs-2 visible-sm visible-md visible-lg">'
              + '<img src="' + e.avatar + '" width="100%" class="img-rounded" />'
            + '</div>'
            + '<div class="col-xs-10">' + body + '</div>'
          + '</div>'
        + '</div>'
        + '<div class="panel-footer">'
          + footer
        + '</div>'
      + '</div>');

      {% if form %}
      if(e.level < 4) {

        $('#data').append(
          '<div id="post' + i + '" class="panel panel-default ' + e.html_class2 + ' hidden" style="margin-bottom: 5px;">'
          + '<div class="panel-body" style="padding: 5px;">'
            + '<div class="row">'
              + '<div class="col-xs-2 visible-sm visible-md visible-lg">'
                + '<img src="' + e.avatar + '" width="100%" class="img-rounded" />'
              + '</div>'
              + '<div class="col-xs-10">' + add_form(e.pk) + '</div>'
            + '</div>'
          + '</div>'
        + '</div>');
      }
      {% endif %}

    }

    {% if root %}
      $(document).ready(loadData({{root}}));
    {% else %}
      $(document).ready(loadData(''));
    {% endif %}

  </script>

{% endblock %}


