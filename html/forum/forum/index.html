<!------------------------------------------------------------------------------------------ 

Hubnemevedvou.cz

Profile index

Page structure:

<ALL>
  <Bread crumbs>
  <id="data"> - this is reloaded during loadData() event
    <id="entries"> - list of entries, for each the render() method is called
  <id="pagination"> - a placeholder, if visible, more entries are fetched using JSON

Basic JSON load scenario:
-replace <Dynamic DIV data> with loading logo
-JSON fetch
-preRender() called, returned HTML will replace <Dynamic DIV data>
-render() called for each entry

------------------------------------------------------------------------------------------->

{% extends 'base/base.html' %}
{% load i18n %}
{% load bootstrap %}

{% block main %}

<div class="row">

  <p id="breadcrumbs"></p>

  <div id="data">
    <!-- First level, categories, are rendered on the server and it's not possibel to get back here thru JSON -->

    {% for category in categories %}
      <div class="well big-faq">
        <div class="row">
          <div class="col-md-2">
            <img src="{{category.image_url}}" class="img-max" />
          </div>
          <div class="col-md-6">
            <h3>{{category.body_html}}</h3>
            <p>{% trans 'Post count' %}: {{category.post_count}}</p>
            {% if category.last_post %}
              {% url profile category.last_post.user as user_url %}

              <p class="text-muted">
                {% blocktrans with date=category.last_post.created user=category.last_post.user id=category.last_post.id %}
                  <a href="javascript:void(0)" onClick="root = '{{id}}'; loadData(preRender);">Last reaction</a> {{date}} by <a href="{{user_url}}">{{user}}</a>
                {% endblocktrans %}
              </p>
            {% endif %}
          </div>
          <div class="col-md-3">
            <p>{% trans 'Post count' %}: {{category.post_count}}</p>
            <a href="javascript:void(0)" class="btn btn-info btn-block" onClick="root = '{{category.id}}'; loadData(preRender);" >{% trans 'Open category' %}</a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div id="pagination"></div>

  {% if not user.is_authenticated %}
  <p class="text-center">
    {% url register as url_register %}

    {% blocktrans %}
    Only <a href="{{url_register}}">registered</a> users can post on the forum.
    {% endblocktrans %}
  </p>
  {% endif %}
</div>

{% endblock %}

{% block extra_script %}
  <script src="{{STATIC_URL}}js/ajax.js"></script>

  {% if form %}
    <script type="bogus" id="form_template">
      {{form|bootstrap}}
    </script>
  {% endif %}

  {% include 'base/loading.html' %}

  <script type="text/javascript" language="javascript">

    function show(i) {
      elem = document.getElementById("post" + i);
      elem.className = elem.className.replace( /(?:^|\s)hidden(?!\S)/g , '' );
      elem.getElementsByTagName('textarea')[0].focus();
    }

    function add_form(reply_to) {
      elem = document.getElementById("form_template");

      var txt = 
        '<form method="post" action="{% url forum_index %}' + reply_to + '/" class="form">'
        + "{% csrf_token %}"
        + elem.innerHTML
        + '<div class="form-group">'
          + '<div>'
            + '<button type="submit" class="btn btn-lg btn-success">{% trans 'Send' %}</button>'
          + '</div>'
        + '</div>'
      + '</form>';

      return txt;
    }

    function preRender(data) {

      /* Setup breadcrumbs */
      var extra = data.extra;
      var txt = '<a href="{% url forum_index %}">Forum</a> &gt; ';
      for (var i = 0; i < extra.breadcrumbs.length; i++) {
        txt += '<a href="javascript:void(0)" onclick="root = ' + extra.breadcrumbs[i].pk + '; loadData(preRender);">';
        txt += extra.breadcrumbs[i].text + '</a>';
        if (i < extra.breadcrumbs.length - 1) {
          txt += " &gt; ";
        }
      }
      $('#breadcrumbs').html('{% trans 'You are in discussion' %} ' + txt);

      var head_button = '';
      if (extra.breadcrumbs.length < 3) {
        head_button = '<a href="javascript:void(0)" class="btn btn-primary" onClick="show(\'_reply_head\')"><span class="glyphicon glyphicon-share-alt"></span> {% trans 'Start new discussion' %}</a>';
      }
 
      /* Render the index head, entries will be rendered later */
      var head_post = extra.breadcrumbs[extra.breadcrumbs.length - 1];
      $('#data').html(
        '<div class="well big-faq"><div class="col-md-2">' +
          '<img src="' + head_post.avatar + '"  class="forum-picture img-circle"/>'
          +'</div>'
          +'<div class="col-md-7"><h3>' 
          + head_post.text 
          +'</h3></div><div class="col-md-2">' 

          {% if user.is_authenticated %}
            + head_button
          {% endif %}

          + '</div><div class="clearfix"></div></div>' +

          {% if user.is_authenticated %}

          /* Add a hidden form */
          '<div id="post_reply_head" class="panel panel-default hidden">' +
            add_form(head_post.pk) + 
          '</div>' +

          {% endif %}

        '<div id="entries" /></div>');
    }

    function render(i, e, last_end) {
      var body = '';
      var footer = '';

      var hidden = '';

      var link = "";
      if (e.level < 3) {
        if (e.pk == root) {
            link = 'onClick="root = \'' + e.parent + '\'; loadData(preRender)"';
        } else {
            link = 'onClick="root = \'' + e.pk + '\'; loadData(preRender)"';
        }
      }

      footer =
          '<div class="col-md-5 text-right">';

      if (e.post_count > 0) {
        footer += '<small>' + e.post_count + ' '+ e.posts + '</small> ';
      }

      footer += '<div class="btn-group btn-group-md">';

      if (e.deletable_link != '') {
        footer += '<a href="' + e.deletable_link + '" class="btn btn-default" ><span class="glyphicon glyphicon-trash"></span> {% trans 'Delete' %}</a>';
      }

      if (link != "") footer += '<a href="javascript:void(0)" ' + link + ' class="btn btn-primary" >{% trans 'Read' %}</a>';

      {% if user.is_authenticated %}

        var show_report = ('{{user}}' != e.user && e.level >= 1);
        var show_subscribe = (e.level == 2);

        if (show_report || show_subscribe) {

          footer += '<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">'
                    + '<span class="caret"></span></button>'
                  + '<ul class="dropdown-menu">';

          if (show_subscribe) {
            if (e.subscribed) {
              footer += '<li><a href="{% url forum_index %}' + e.pk + '/?subscribe=0"><span class="glyphicon glyphicon-bell"></span> {% trans 'Unsubscribe' %}</a></li>';
            } else {
              footer += '<li><span class="glyphicon glyphicon-bell"></span><a href="{% url forum_index %}' + e.pk + '/?subscribe=1"> {% trans 'Subscribe' context 'button' %}</a></li>';
            }
          }

          if (show_report) {

            if (show_subscribe) footer += '<li class="divider"></li>';

            footer += '<li><a href="{% url report 'sexual' %}?target_id=' + e.pk + '&target=Post">{% trans 'Sexual Remarks' %}</a></li>'
                  + '<li><a href="{% url report 'advertising' %}?target_id=' + e.pk + '&target=Post">{% trans 'Advertising' %}</a></li>'
                  + '<li><a href="{% url report 'abuse' %}?target_id=' + e.pk + '&target=Post">{% trans 'Other Abuse' %}</a></li>'
                + '</ul>';
           }
        }

      {% endif %}


      body += '<p>' + e.text + '</p>';


      if (e.level == 3) {
        var s = i;

//        if (e.level == 4) s = last_end;

      }

      footer += '</div></div></div>';

      var offset = '';
      if (e.level == '4') {
        offset = 'col-xs-offset-1';
      }

      var show_user = '';

      if (e.level > 1) {
        show_user = '<small>' + e.user + '</small>';
      }

      var last_post = '';
      if (e.level < 3 && e.last_post) {
        last_post = '{% blocktrans %}<a href="javascript:void(0)" onClick="root = \'' + e.last_post.id + '\'; loadData(preRender);">Last reaction</a> ' + e.last_post.date + ' by <a href="/profile/' + e.user + '/">' + e.user + '</a>{% endblocktrans %}'
      }

      var shade_alternation = '';
      if (i % 2 == 1) shade_alternation = 'shade';

      $('#entries').append(
        '<div class="panel panel-default big-favorities ' + offset + ' ' + shade_alternation + '">'
        + '<div class="panel-body link-glow" >'
            + '<div class="col-md-2">'
              + '<img src="' + e.avatar + '" width="100%" class="img-circle img-max" />'
            + '</div>'
            + '<div class="col-md-5">' 
              + show_user
              + body
              + last_post
            + '</div>'
          + footer
        + '</div>'
      + '</div>');

      {% if form %}
      if(e.level >= 3) {

        $('#entries').append(
          '<div id="post' + i + '" class="panel panel-default hidden" style="margin-bottom: 5px;">'
          + '<div class="panel-body" style="padding: 5px;">'
            + '<div class="row">'
              + '<div class="col-xs-2 visible-sm visible-md visible-lg">'
                + '<img src="{{user.forum_profile.avatar_url}}" width="100%" class="img-rounded" />'
              + '</div>'
              + '<div class="col-xs-10">' + add_form(e.pk) + '</div>'
            + '</div>'
          + '</div>'
        + '</div>');
      }
      {% endif %}

    }

    var ajax_url = '/data/';

    {% if root %}
      root = '{{root}}';
    {% else %}
      root = '';
    {% endif %}

    {% if not categories %}    
      $(document).ready(loadData(preRender));
    {% endif %}

    window.onscroll = scrollFunction;

  </script>

{% endblock %}


