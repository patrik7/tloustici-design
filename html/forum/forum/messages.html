{% extends base_template %}

{% load i18n %}
{% load base_tags %}

{% block extra_meta %}

  <link href="{{STATIC_URL}}css/typeahead.js-bootstrap.css" rel="stylesheet" />

  <style>
    .unread { background-color:#b0c4de; }
  </style>
{% endblock %}

{% block main %}

  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title"><span class="glyphicon glyphicon-envelope"></span> {% trans 'Write Private Message' %}</h3>
    </div>
    <div class="panel-body">
      {% include 'form.html' with form=new_form button='Send' name='new' %}
    </div>
  </div>

  <div id="data"></div>
  <div id="pagination"></div>

{% endblock %}

{% block extra_script %}

  <script src="{{STATIC_URL}}js/typeahead.min.js"></script>
  <script src="{{STATIC_URL}}js/hogan-2.0.0.min.js"></script>
  <script src="{{STATIC_URL}}js/ajax.js"></script>

  <script id="form_msg" type="bogus">
    <div class="panel panel-info col-xs-offset-1">
      <div class="panel-body">
        {% include "form.html" with form=form_hidden_addressee name='' button='Send' %}
      </div>
    </div>
  </script>

  {% include 'base/loading.html' %}

  <script type="text/javascript" language="javascript">  
    var ajax_url = '/forum/conversation/data/';

    $('#id_addressee').typeahead({
      name: 'addressee',
      remote: '/login/data/%QUERY.json',
      template: [                                                                 
{% verbatim %}
        '<image src="{{avatar}}" class="img" style="width: auto; height: 30px;" /> {{value}}',
{% endverbatim %}
      ].join(''),
      engine: Hogan
    });

    $('.tt-hint').addClass('form-control');

    function renderMessages(elem, entries, unread) {

      for (var i = 0; i < entries.length; i++) {
        var mark_unread = false;
        if (unread > 0) {
          if (entries[i].other_user != '{{user.username}}') {
            mark_unread = true;
            unread--;
          }
        }
        render_message(elem, entries[i], mark_unread);
      }
    }

    function addForm(elem, other_user) {
      e = document.getElementById("form_msg");
      elem.append(e.innerHTML);

      elem.find('textarea').focus();
      elem.find('#id_addressee').attr('value', other_user);
    }

    function hideMessages(div_id, conversation_id, other_user) {
      delete dynamic_pagination[conversation_id];
      $('#popu' + div_id).html('');
 
      c = $('#conversation' + div_id + ' .panel-body');
      c.attr('onclick', 'javascript:loadMessages(' + div_id + ', ' + conversation_id + ', \'' + other_user + '\', 0);');
     
    }

    function loadMessages(div_id, conversation_id, other_user, unread) {
      setLoading('popu' + div_id);

      $.getJSON('/forum/messages/data/', {'conversation': conversation_id}).done(function(data) {
        var entries = data.entries;
        var pagination = data.pagination;

        //remove badge 
        $('#conversation' + div_id + ' .badge').remove();

        elem = $('#popu' + div_id);
        elem.html('');
        addForm(elem, other_user);
        renderMessages(elem, entries, unread);
        setupMessagesPagination(data.pagination, data.entries[data.entries.length -1 ], conversation_id, div_id);

        c = $('#conversation' + div_id + ' .panel-body');
        c.attr('onclick', 'javascript:hideMessages(' + div_id + ', ' + conversation_id + ', \'' + other_user + '\');');

      }).fail(function () {
        setError('popu' + div_id)
      });
    }

    function addMessages(conversation_id, filter_down, div_id) {
      $.getJSON('/forum/messages/data/', {'conversation': conversation_id, 'filter_down': filter_down}).done(function(data) {
        var entries = data.entries;
        var pagination = data.pagination;

        elem = $('#popu' + div_id);
        renderMessages(elem, entries, 0);
        setupMessagesPagination(data.pagination, data.entries[data.entries.length - 1], conversation_id, div_id);

        $('#pagination' + conversation_id).html('');
      }).fail(function () {
        setError('popu' + div_id)
      });

    }

    function setupMessagesPagination(pg, e, c_id, div_id) {
      if (pg.has_next) {
        dynamic_pagination[c_id] = {};
        dynamic_pagination[c_id].elem = '#pagination' + c_id;
        dynamic_pagination[c_id].fnc = function() {
          dynamic_pagination[c_id].fnc = function() {}
          setLoading('pagination' + c_id);

          addMessages(c_id, e.pk, div_id);
        }
      }
    }

    function render_message(elem, e, unread) {
      var body = '';

      body += '<div class="pull-right text-muted"><small>' + e.date + '</small></div>';
      body += '<p>' + e.text + '</p>';

      elem.append(
        '<div class="panel panel-default col-xs-offset-1" style="margin-bottom: 5px;">'
        + '<div class="panel-body' + (unread ? ' unread' : '') + '" style="padding: 5px;">'
          + '<div class="row">'
            + '<div class="col-xs-2 visible-sm visible-md visible-lg">'
              + '<img src="' + e.avatar + '" width="100%" class="img-rounded" />'
            + '</div>'
            + '<div class="col-xs-10">' + body + '</div>'
          + '</div>'
        + '</div>'
      + '</div>');

    }

    function render(i, e, last_end) {
      var body = '';

      var footer = '';

      body += '<div class="text-right" style="color: #505050;"><small>{% trans 'Last message' %}: ' + e.last_message + '</small></div>';
      body += '<p>{% trans 'Conversation with' %} <a href="' + e.other_user_link + '">' + e.other_user + '</a>';
      if (e.unread > 0) {
        body += ' <span class="badge">' + e.unread + '</span>'; 
      }
      body += '</p>';

      link = 'javascript:loadMessages(' + i + ', ' + e.id + ', \'' + e.other_user + '\', ' + e.unread + ');'

      $('#data').append(
        '<div id="conversation' + i + '" class="panel panel-default ' + e.html_class + '" style="margin-bottom: 5px;">'
        + '<div class="panel-body link-glow" style="padding: 5px;" onclick="' + link + '">'
          + '<div class="row">'
            + '<div class="col-xs-2 visible-sm visible-md visible-lg">'
              + '<img src="' + e.avatar + '" width="100%" class="img-rounded" />'
            + '</div>'
            + '<div class="col-xs-10">' + body + '</div>'
          + '</div>'
        + '</div>'
        + '<div class="panel-footer">' + footer + '</div>'
      + '</div><div id="popu' + i + '"></div><div id="pagination' + e.id  + '"></div>');

    }

    $(document).ready(loadData());

    var dynamic_pagination = {};

    window.onscroll = function () {
      //pagination for conversations
      if (isScrolledIntoView('#pagination')) {
        loadDataMore(); //function definition keeps changing
      }

      for (var c_id in dynamic_pagination)
      {
        var dp = dynamic_pagination[c_id];        
        if (isScrolledIntoView(dp.elem)) dp.fnc();
      }
    }

  </script>

{% endblock %}

